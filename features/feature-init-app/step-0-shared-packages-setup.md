# Step 0: Shared Packages Setup

## Goal
Create shared packages structure for common code used across frontend and backend. Packages are organized by purpose (models, utils, etc.) and accessed via TypeScript path aliases - no separate build step required.

## Prerequisites
- Root tsconfig.json exists
- Understanding of TypeScript path mapping

## Package Structure Philosophy

Each package has a **focused purpose**:
- `shared-models` - Zod schemas and inferred types
- `shared-utils` - Common utilities and helpers
- `shared-types` - TypeScript types and enums (like QueryKeys)
- Future: `shared-constants`, `shared-config`, etc.

**Key Points:**
- ❌ No individual package.json files
- ❌ No separate build step
- ✅ Use root tsconfig for all packages
- ✅ Direct TypeScript imports via path aliases

## Files to Create
- `packages/shared-models/index.ts` - Barrel export for models
- `packages/shared-models/user.model.ts` - User Zod schema
- `packages/shared-models/auth.model.ts` - Auth Zod schemas
- `packages/shared-types/index.ts` - Barrel export for types
- `packages/shared-types/query-keys.ts` - React Query key enums
- Root `tsconfig.json` - Update with path aliases

## Implementation Details

### 1. Create Package Directories

```bash
mkdir -p packages/shared-models
mkdir -p packages/shared-types
mkdir -p packages/shared-utils
```

### 2. Update Root TypeScript Config

Update `tsconfig.json` in project root:

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "lib": ["ES2022"],
    "moduleResolution": "bundler",
    "strict": true,
    "skipLibCheck": true,
    "esModuleInterop": true,
    "resolveJsonModule": true,

    // Path aliases for packages
    "baseUrl": ".",
    "paths": {
      "@quiz-app/shared-models": ["./packages/shared-models"],
      "@quiz-app/shared-models/*": ["./packages/shared-models/*"],
      "@quiz-app/shared-types": ["./packages/shared-types"],
      "@quiz-app/shared-types/*": ["./packages/shared-types/*"],
      "@quiz-app/shared-utils": ["./packages/shared-utils"],
      "@quiz-app/shared-utils/*": ["./packages/shared-utils/*"]
    }
  }
}
```

### 3. Update App TypeScript Configs

Both apps should extend root config.

**Update `apps/api/tsconfig.json`:**
```json
{
  "extends": "../../tsconfig.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src",
    "experimentalDecorators": true,
    "emitDecoratorMetadata": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

**Update `apps/ui/tsconfig.app.json`:**
```json
{
  "extends": "../../tsconfig.json",
  "compilerOptions": {
    "target": "ES2020",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "jsx": "react-jsx",
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true
  },
  "include": ["src"]
}
```

### 4. Create User Model (`packages/shared-models/user.model.ts`)

```typescript
import { z } from 'zod'

/**
 * User Zod Schema
 * Used for validation in backend and type inference in frontend
 */
export const UserSchema = z.object({
  id: z.string(),
  username: z.string().min(3).max(20),
  email: z.string().email(),
  createdAt: z.date(),
  updatedAt: z.date(),
})

/**
 * User type inferred from Zod schema
 * Use this instead of defining separate types
 */
export type User = z.infer<typeof UserSchema>

/**
 * Create User Schema (for registration/creation)
 * Omits id and timestamps as they're generated by database
 */
export const CreateUserSchema = z.object({
  username: z.string().min(3).max(20),
  email: z.string().email(),
  password: z.string().min(6).max(100),
})

export type CreateUser = z.infer<typeof CreateUserSchema>

/**
 * Safe User Schema (without sensitive data)
 * Used for API responses
 */
export const SafeUserSchema = z.object({
  id: z.string(),
  username: z.string(),
  email: z.string(),
  createdAt: z.date(),
  updatedAt: z.date(),
})

export type SafeUser = z.infer<typeof SafeUserSchema>
```

### 5. Create Auth Models (`packages/shared-models/auth.model.ts`)

```typescript
import { z } from 'zod'
import { SafeUserSchema } from './user.model'

/**
 * Login Credentials Schema
 */
export const LoginSchema = z.object({
  email: z.string().email('Invalid email address'),
  password: z.string().min(1, 'Password is required'),
})

export type LoginCredentials = z.infer<typeof LoginSchema>

/**
 * Register Credentials Schema
 */
export const RegisterSchema = z.object({
  username: z
    .string()
    .min(3, 'Username must be at least 3 characters')
    .max(20, 'Username must not exceed 20 characters')
    .regex(
      /^[a-zA-Z0-9_]+$/,
      'Username can only contain letters, numbers, and underscores'
    ),
  email: z.string().email('Invalid email address'),
  password: z
    .string()
    .min(6, 'Password must be at least 6 characters')
    .max(100, 'Password must not exceed 100 characters'),
})

export type RegisterCredentials = z.infer<typeof RegisterSchema>

/**
 * Auth Response Schema
 */
export const AuthResponseSchema = z.object({
  access_token: z.string(),
  user: SafeUserSchema,
})

export type AuthResponse = z.infer<typeof AuthResponseSchema>

/**
 * JWT Payload Schema
 */
export const JwtPayloadSchema = z.object({
  sub: z.string(), // user ID
  email: z.string().email(),
  username: z.string(),
  iat: z.number().optional(),
  exp: z.number().optional(),
})

export type JwtPayload = z.infer<typeof JwtPayloadSchema>
```

### 6. Create Query Keys (`packages/shared-types/query-keys.ts`)

```typescript
/**
 * React Query Keys Enum
 * Centralized query key definitions for type safety and consistency
 *
 * ALWAYS use these enums, NEVER use string literals
 */
export enum QueryKeys {
  // Auth
  AUTH_PROFILE = 'auth.profile',

  // Users
  USERS = 'users',
  USER_BY_ID = 'users.byId',

  // Quizzes (for future use)
  QUIZZES = 'quizzes',
  QUIZ_BY_ID = 'quizzes.byId',
  QUIZ_CATEGORIES = 'quizzes.categories',

  // Attempts
  USER_ATTEMPTS = 'attempts.user',
  ATTEMPT_BY_ID = 'attempts.byId',

  // Dashboard
  DASHBOARD = 'dashboard',
  USER_PROGRESS = 'progress.user',

  // Leaderboard
  LEADERBOARD = 'leaderboard',
  LEADERBOARD_BY_QUIZ = 'leaderboard.byQuiz',

  // Challenges
  DAILY_CHALLENGE = 'challenges.daily',
  WEEKLY_CHALLENGE = 'challenges.weekly',
}

/**
 * Helper functions to create parameterized query keys
 */
export const createQueryKey = {
  userById: (id: string) => [QueryKeys.USER_BY_ID, id] as const,
  quizById: (id: string) => [QueryKeys.QUIZ_BY_ID, id] as const,
  attemptById: (id: string) => [QueryKeys.ATTEMPT_BY_ID, id] as const,
  leaderboardByQuiz: (quizId: string) => [QueryKeys.LEADERBOARD_BY_QUIZ, quizId] as const,
}
```

### 7. Create Barrel Exports

**`packages/shared-models/index.ts`:**
```typescript
// User models
export * from './user.model'

// Auth models
export * from './auth.model'

// Future: quiz.model, attempt.model, etc.
```

**`packages/shared-types/index.ts`:**
```typescript
// Query keys
export * from './query-keys'

// Future: common types, utility types, etc.
```

**`packages/shared-utils/index.ts`:**
```typescript
// Placeholder for future utilities
// e.g., formatters, validators, helpers
```

### 8. Install Zod at Root

Since packages don't have their own package.json, install Zod at the root:

```bash
pnpm add zod
```

This makes Zod available to all packages and apps.

### 9. Update Vite Config for Path Aliases (Frontend)

**Update `apps/ui/vite.config.ts`:**
```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react-swc'
import tailwindcss from '@tailwindcss/vite'
import { TanStackRouterVite } from '@tanstack/router-plugin/vite'
import path from 'path'

export default defineConfig({
  plugins: [
    TanStackRouterVite(),
    react(),
    tailwindcss(),
  ],
  resolve: {
    alias: {
      '@quiz-app/shared-models': path.resolve(__dirname, '../../packages/shared-models'),
      '@quiz-app/shared-types': path.resolve(__dirname, '../../packages/shared-types'),
      '@quiz-app/shared-utils': path.resolve(__dirname, '../../packages/shared-utils'),
    },
  },
})
```

### 10. Update NestJS Module Aliases (Backend)

**Update `apps/api/tsconfig.json`:**
```json
{
  "extends": "../../tsconfig.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src",
    "experimentalDecorators": true,
    "emitDecoratorMetadata": true,

    // Ensure paths are inherited from root
    "baseUrl": "../../",
    "paths": {
      "@quiz-app/shared-models": ["packages/shared-models"],
      "@quiz-app/shared-models/*": ["packages/shared-models/*"],
      "@quiz-app/shared-types": ["packages/shared-types"],
      "@quiz-app/shared-types/*": ["packages/shared-types/*"],
      "@quiz-app/shared-utils": ["packages/shared-utils"],
      "@quiz-app/shared-utils/*": ["packages/shared-utils/*"]
    }
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

## Benefits of This Approach

### 1. **Simple & Direct**
- No build step for packages
- No separate package.json to maintain
- TypeScript compiles everything together

### 2. **Organized by Purpose**
- `shared-models` = Data structures and schemas
- `shared-types` = TypeScript types and enums
- `shared-utils` = Helper functions
- Easy to find and understand

### 3. **Fast Development**
- No rebuild when changing shared code
- Hot reload works across packages
- Faster TypeScript compilation

### 4. **Type Safety**
- Single source of truth for data structures
- TypeScript path mapping ensures imports work
- Zod validates at runtime

## Usage Examples

### Backend (NestJS Controller)
```typescript
import { RegisterSchema, type RegisterCredentials } from '@quiz-app/shared-models'
import { createZodDto } from 'nestjs-zod'

// Create DTO from Zod schema
export class RegisterDto extends createZodDto(RegisterSchema) {}

@Post('register')
async register(@Body() dto: RegisterDto) {
  // Type is RegisterCredentials
  return this.authService.register(dto)
}
```

### Frontend (React Component)
```typescript
import { RegisterSchema, type RegisterCredentials } from '@quiz-app/shared-models'
import { QueryKeys } from '@quiz-app/shared-types'
import { zodResolver } from '@hookform/resolvers/zod'

// Use in form validation
const form = useForm<RegisterCredentials>({
  resolver: zodResolver(RegisterSchema),
})

// Use query keys
const { data } = useQuery({
  queryKey: [QueryKeys.AUTH_PROFILE],
  queryFn: () => api.get('/auth/profile'),
})
```

## Verification Steps

1. **Create package directories:**
   ```bash
   mkdir -p packages/shared-models
   mkdir -p packages/shared-types
   mkdir -p packages/shared-utils
   ```

2. **Install Zod:**
   ```bash
   pnpm add zod
   ```

3. **Create files with content above**

4. **Test imports in backend:**
   ```typescript
   // In apps/api/src/test.ts
   import { RegisterSchema } from '@quiz-app/shared-models'
   import { QueryKeys } from '@quiz-app/shared-types'
   console.log(RegisterSchema, QueryKeys.AUTH_PROFILE)
   ```

5. **Test imports in frontend:**
   ```typescript
   // In apps/ui/src/test.ts
   import { RegisterSchema } from '@quiz-app/shared-models'
   import { QueryKeys } from '@quiz-app/shared-types'
   console.log(RegisterSchema, QueryKeys.AUTH_PROFILE)
   ```

6. **Check TypeScript compilation:**
   ```bash
   # Backend
   cd apps/api
   tsc --noEmit

   # Frontend
   cd apps/ui
   tsc --noEmit
   ```

## Success Criteria
✅ Package directories created (shared-models, shared-types, shared-utils)
✅ Root tsconfig updated with path aliases
✅ App configs extend root tsconfig
✅ Zod installed at root
✅ Vite config has path aliases
✅ Models created and exported
✅ Query keys enum created
✅ Imports work in both apps
✅ TypeScript compilation succeeds

## File Structure After This Step
```
quiz-app/
├── packages/
│   ├── shared-models/
│   │   ├── index.ts           # Barrel export
│   │   ├── user.model.ts      # User schemas
│   │   └── auth.model.ts      # Auth schemas
│   ├── shared-types/
│   │   ├── index.ts           # Barrel export
│   │   └── query-keys.ts      # Query key enums
│   └── shared-utils/
│       └── index.ts           # Utilities (placeholder)
├── tsconfig.json              # Root config with path aliases
├── apps/
│   ├── api/
│   │   └── tsconfig.json      # Extends root, adds paths
│   └── ui/
│       ├── tsconfig.app.json  # Extends root
│       └── vite.config.ts     # Path aliases for Vite
└── pnpm-workspace.yaml        # Workspace config (no changes needed)
```

## Note on Package Organization

As the project grows, create more focused packages:

```
packages/
├── shared-models/         # Zod schemas & inferred types
├── shared-types/          # TS types, enums, interfaces
├── shared-utils/          # Common utilities
├── shared-constants/      # Constants, config
├── shared-validators/     # Custom validators
└── shared-hooks/          # Shared React hooks (if needed)
```

Each package:
- Has a clear, focused purpose
- Exports via `index.ts` barrel file
- Is imported via `@quiz-app/package-name`
- No build step, no package.json

## Troubleshooting

**Issue:** Cannot find module '@quiz-app/shared-models'
- **Fix:** Check tsconfig.json has correct paths
- Restart TypeScript server in IDE
- Check import path matches exactly

**Issue:** Vite can't resolve alias
- **Fix:** Check vite.config.ts has resolve.alias
- Path must be absolute (use path.resolve)
- Restart Vite dev server

**Issue:** NestJS can't find imports
- **Fix:** Check apps/api/tsconfig.json baseUrl is "../../"
- Check paths array matches root tsconfig
- Run `tsc --noEmit` to see errors

**Issue:** Zod not found
- **Fix:** Install at root: `pnpm add zod`
- Should be in root package.json dependencies

## Next Steps
After completing this step:
- Proceed to Step 1: Install Dependencies
- In Step 11 (User Schema): Use models from `@quiz-app/shared-models`
- In Step 12 (Auth Endpoints): Import DTOs from `@quiz-app/shared-models`
- In Step 13-15 (Auth UI): Import schemas and types from shared packages
- All future features will use shared packages

**Remember:** No package.json files in packages folders, everything uses root config!
